# --- OPTIONS --- #

# Term options recommended by nvim checkhealth
# set-option -g default-terminal "screen-256color"
# set-option -sa terminal-features ',xterm-256color:RGB'
set-option -g set-titles on
set-option -g set-titles-string "[#W] #{s|/Users/petermariani|~|:pane_current_path}"

set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",*256col*:Tc"
set -ga terminal-overrides '*:Ss=\E[%p1%d q:Se=\E[ q'
set-environment -g COLORTERM "truecolor"

# # Undercurl from nvim tokyonight
# # set -g default-terminal "${TERM}"
# set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'  # undercurl support
# set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'  # underscore colours - needs tmux-3.0

# Seggestion by Sesh
set -g detach-on-destroy off  # don't exit from tmux when closing a session

set -g default-command /bin/zsh
# Add true color & italics support with alacritty terminal
# set -g default-terminal "alacritty"
# set -s default-terminal "screen-256color"
set -g mouse on

# don't rename windows automatically
set -g allow-rename off
# allows for autoread in vim
set -g focus-events on
# address vim mode switching delay (http://superuser.com/a/252717/65504)
set -sg escape-time 10
# increase scrollback buffer size
set -g history-limit 50000
# tmux messages are displayed for 4 seconds
set -g display-time 1000

# start window indexing at one instead of zero
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on

# Start with status bar off
set -g status off
# Turn status ON when more than one window
set-hook -g after-new-window 'if "[ #{session_windows} -gt 1 ]" "set -g status on"'
# Turn status OFF when only one window left
set-hook -g after-kill-pane 'if "[ #{session_windows} -lt 2 ]" "set -g status off"'
set-hook -g window-layout-changed 'if "[ #{session_windows} -lt 2 ]" "set -g status off"'


# --- KEYBINDINGS --- #

# prefix keys
unbind C-b
set -g prefix C-a
bind C-a send-prefix
set -g prefix2 F1
bind F1 send-prefix -2

# move left/right windows
bind C-p previous-window
bind C-n next-window
# bind \\ next-window
# bind \| previous-window
bind -r C-h previous-window
bind -r C-l next-window
bind h previous-window
bind l next-window

bind u set status off
bind i set status on

# window splitting
unbind %
bind v split-window -h
bind b split-window -v

# easy source
bind R source-file ~/.tmux.conf \; display-message "Config reloaded..."

unbind j

# toggle tatusline
bind-key u run-shell 'tmux set status $([ "$(tmux show -v status)" = "on" ] && echo off || echo on)'
unbind i

# Sesh START
bind-key " " display-popup -E -w 40% "sesh connect \"$(
 sesh list -i | gum filter --limit 1 --no-sort --no-strip-ansi --fuzzy --placeholder 'Pick a sesh' --height 50 --prompt='‚ö°'
)\""

# bind-key " " run-shell "sesh connect \"$(
#   sesh list --icons | fzf-tmux -p 80%,70% \
#     --no-sort --ansi --border-label ' sesh ' --prompt '‚ö°  ' \
#     --header '  ^a all ^t tmux ^g configs ^x zoxide ^d tmux kill ^f find' \
#     --bind 'tab:down,btab:up' \
#     --bind 'ctrl-a:change-prompt(‚ö°  )+reload(sesh list --icons)' \
#     --bind 'ctrl-t:change-prompt(ü™ü  )+reload(sesh list -t --icons)' \
#     --bind 'ctrl-g:change-prompt(‚öôÔ∏è  )+reload(sesh list -c --icons)' \
#     --bind 'ctrl-x:change-prompt(üìÅ  )+reload(sesh list -z --icons)' \
#     --bind 'ctrl-f:change-prompt(üîé  )+reload(fd -H -d 2 -t d -E .Trash . ~)' \
#     --bind 'ctrl-d:execute(tmux kill-session -t {2..})+change-prompt(‚ö°  )+reload(sesh list --icons)' \
#     --preview-window 'right:55%' \
#     --preview 'sesh preview {}'
# )\""

bind -N "last-session (via sesh) " \\ run-shell "sesh last"
# Sesh END

# --- APPEARANCE --- #

# statusline position
set-option -g status-position top

# statusline color
set-option -g status-style bg=default
# set -g status-bg 'colour17'
# set -g status-bg '#15152f'
# set -g status-bg '#0f0f0f'

set -g status-fg 'colour252'

# statusline left
# set -g status-left ' '
# set -g status-right '#[italics]#[fg=colour248]#{s|/Users/petermariani|~|:pane_current_path}   #[default]#[fg=colour5] #S    #[fg=colour6]%H:%M '
# set -g status-left '#[fg=colour5] #S   #[fg=colour237]| '
# set -g status-right '#[italics]#[fg=colour248]#{s|/Users/petermariani|~|:pane_current_path}    #[default]#[fg=colour2]%H:%M '
set -g status-left '#[fg=colour237]| '
set -g status-right '#[fg=colour243]#{s|/Users/petermariani|~|:pane_current_path}    #[default]%H:%M    #[italics]#[fg=colour2]ÓØà #S:#I '

# pain border
# muted green colour58
# set -g pane-active-border-style "bg=colour233 fg=colour18"
# set -g pane-border-style        "bg=colour233 fg=colour18"
set -g pane-active-border-style "fg=colour8"
set -g pane-border-style        "fg=colour8"
# set -g pane-active-border-style "bg=colour234 fg=colour234"
# set -g pane-border-style        "bg=colour234 fg=colour234"

# message line
# set -g message-style "fg=colour208,bg=colour234"
set -g message-style "fg=colour2"

# statusline right
set -g status-right-length "80"
set -g status-left-length "80"

# statusline window names
# setw -g window-status-format         "#[fg=colour237]|#[fg=colour8]   #W  #[default]"
# setw -g window-status-current-format "#[fg=colour6]|   #[italics]#[fg=colour254]#W  #[default]"
# setw -g window-status-format         "#[fg=colour237]|#[fg=colour8]   #W  #[default]"
# setw -g window-status-current-format "#[fg=colour237]|#[fg=colour6] - #[italics]#[fg=colour254]#W #[default]#[fg=colour6]-#[default]"
setw -g window-status-format         "#[fg=colour243]  #W   #[fg=colour237]|#[default]"
setw -g window-status-current-format "#[fg=colour2]  #[italics]#W   #[default]#[fg=colour237]|#[default]"

# window backgrounds
# setw -g window-style "bg=colour234" #234
# setw -g window-active-style "bg=colour232"

# copy mode - (not working now with iTerm2)
setw -g mode-style bg=magenta

# -------------------------------------------------------------------------------

# Tmux Plugin Manager (TPM)
#   To use the plugins TPM must be installed. If not installed:
#   1. git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
#   2. Reload tmux if it's already started with `r
#   3. Launch tmux and hit `I to fetch any plugins

# List of plugins
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'christoomey/vim-tmux-navigator'
# set -g @plugin 'tmux-plugins/tmux-resurrect' # persist tmux sessions after computer restart
# set -g @plugin 'tmux-plugins/tmux-continuum' # automatically saves sessions for you every 15 minutes

# set -g @resurrect-capture-pane-contents 'on' # allow tmux-ressurect to capture pane contents
# set -g @resurrect-strategy-nvim 'session'
# set -g @continuum-restore 'on' # enable tmux-continuum functionality

# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run -b '~/.tmux/plugins/tpm/tpm'


# -------------------------------------------------------------------------------

# # only show status bar if there is more then one window
# set -g status off
# set-hook -g after-new-window      'if "[ #{session_windows} -gt 1 ]" "set status on"'
# set-hook -g after-kill-pane       'if "[ #{session_windows} -lt 2 ]" "set status off"'
# set-hook -g pane-exited           'if "[ #{session_windows} -lt 2 ]" "set status off"'
# set-hook -g window-layout-changed 'if "[ #{session_windows} -lt 2 ]" "set status off"'


# -------------------------------------------------------------------------------

# --- BONEYARD --- #

# upgrade $TERM

# ---------------------------
# SSH ssh-agent forwarding
# ---------------------------
# Remove SSH_AUTH_SOCK to disable tmux automatically resetting the variable
# set -g update-environment "DISPLAY SSH_ASKPASS SSH_AGENT_PID SSH_CONNECTION WINDOWID XAUTHORITY"

# Use a symlink to look up SSH authentication
# setenv -g SSH_AUTH_SOCK $HOME/.ssh/ssh_auth_sock

# point SSH_AUTH_SOCK to a symlink which is pointing to a ssh-agent socket;
# this way all panes will have a valid value in SSH_AUTH_SOCK
# set-environment -g 'SSH_AUTH_SOCK' ~/.ssh/ssh_auth_sock


# set -g default-terminal "tmux-256color"
# setw -g xterm-keys on # for vim
# setw -g mode-keys vi # vi key
# set -g terminal-overrides 'xterm*:smcup@:rmcup@'

# set -g @plugin 'jimeh/tmux-themepack'
# set -g @plugin 'tmux-plugins/tmux-sensible'

# utf8 is on
# set -g utf8 on
# set -g status-utf8 on

# refresh 'status-left' and 'status-right' more often
# set -g status-interval 5

# Use prefix C-l to clear the visible scrollback lines
# bind C-l send-keys 'C-l'

# setw -g automatic-rename
# set -g visual-activity on

# set -g status-left '#[fg=colour242]#{s|/home/pete|~|:pane_current_path} #(bash ~/.tmux/git_tmux_statusbar.sh #{pane_current_path}) #[default]'
# set -g status-left '#[fg=colour24]#{pane_current_path} #[default]'

# hostname #h
# set-option -g status-interval 2

# set -g status-justify left
